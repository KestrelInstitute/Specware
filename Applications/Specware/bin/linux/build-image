#!/bin/bash --noprofile

# This script creates a Specware4 image (.dxl file). It does not
# do a bootstrap. That is, it does not generate a new Specware4.lisp.

# The --noprofile inhibits loading of ~/.bash_profile and ~/.profile
# files. See man bash for details. The 'set -v' turns on echoing of
# lines read. this will be removed later.

act='build image'

PATH=/bin:/usr/bin:/etc:/sbin:/usr/sbin

set -v

# Test whether SPECWARE4 has been set

if [ -z "$SPECWARE4" ]; then
    echo "Failed to $act, SPECWARE4 environment variable not set" 2>&1
    exit 1
fi

# Test whether SPECWARE4 is a directory

if [ ! -d "$SPECWARE4" ]; then
   echo "Failed to $act, $SPECWARE4 is not a directory" 2>&1
   exit 1
fi

# Ensure SPECWARE4 is set to full pathname:

case "$SPECWARE" in
    /*) : ok;;
    *)  SPECWARE="`pwd`/$SPECWARE";;
esac

# Try to find lisp executable:

if [ -z "$LISP" ]; then
   for L in /usr/local/acl/acl62/alisp /usr/local/acl/acl61/alisp /usr/local/acl/acl501/lisp; do
      if [ -x "$L" ]; then
         LISP="$L"; break
      fi
   done
fi

if [ -z "$LISP" ]; then
   echo "Failed to $act, no LISP executable found" 2>&1
   exit 1
fi

if [ ! -x "$LISP" ]; then
   echo "Failed to $act, $LISP is not executable" 2>&1
   exit 1
fi

if [ ! -d "$SPECWARE4"/Applications/Specware ]; then
   echo "Failed to $act: could not find directory
   $SPECWARE4/Applications/Specware" 2>&1
   exit 1
fi

cd "$SPECWARE4"/Applications/Specware

export SWPATH; SWPATH="$SPECWARE4":.

if [ ! -f lisp/Specware4.lisp ] ; then
   echo "Failed to $act: could not find $SPECWARE4/Applications/Specware/lisp/Specware4.lisp" 2>&1
   exit 1
fi

cp -f bin/linux/Specware4.dxl bin/linux/Specware4-save.dxl

cd Handwritten/Lisp

# We load the new Specware4.lisp twice, each in a fresh lisp session. The
# first time compiles everything.  This may not be necessary but it is
# easier just to load it twice rather than to try to figure out if something
# needs to be compiled.
$LISP <<-XXXX
    (load "Specware4.lisp")
XXXX

# The second time is just to do the dumplisp. If we do it in one go,
# and something needs compiling, the generated dxl file is almost 4
# times larger.
#
# I once added a (gc) between the load and the dumplisp, and the dxl
# file became 10k bigger. Go figure.
#
# I don't know what setting *DEFAULT-RIGHT-MARGIN* does. Can someone explain?
# Do we need it here?
$LISP <<-XXXX
	(load "Specware4.lisp")
	(let (#+ALLEGRO (EXCL::*DEFAULT-RIGHT-MARGIN* 1000))
	(excl::dumplisp :name "$SPECWARE4/Applications/Specware/bin/linux/Specware4.dxl"))
XXXX
