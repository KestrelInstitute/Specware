#!/bin/bash --noprofile

# This script creates a Specware4 image (.dxl file). It does not
# do a bootstrap. That is, it does not generate a new Specware4.lisp.

# The --noprofile inhibits loading of ~/.bash_profile and ~/.profile
# files. See man bash for details. The 'set -v' turns on echoing of
# lines read. this will be removed later.

act='build image'

PATH=/bin:/usr/bin:/etc:/sbin:/usr/sbin

# set -v

# Test whether SPECWARE4 has been set

if [ -z "$SPECWARE4" ]; then
    echo "Failed to $act, SPECWARE4 environment variable not set" 2>&1
    exit 1
fi

# Test whether SPECWARE4 is a directory

if [ ! -d "$SPECWARE4" ]; then
   echo "Failed to $act, $SPECWARE4 is not a directory" 2>&1
   exit 1
fi

# Ensure SPECWARE4 is set to full pathname:

case "$SPECWARE" in
    /*) : ok;;
    *)  SPECWARE="`pwd`/$SPECWARE";;
esac

# Try to find lisp executable:

if [ -z "$LISP" ]; then
   for L in "$HOME"/cmucl/bin/lisp /usr/share/cmulisp/bin/lisp /usr/local/bin/cmucl; do
      if [ -x "$L" ]; then
         LISP="$L"; break
      fi
   done
fi

if [ -z "$LISP" ]; then
   echo "Failed to $act, no LISP executable found" 2>&1
   exit 1
fi

if [ ! -x "$LISP" ]; then
   echo "Failed to $act, $LISP is not executable" 2>&1
   exit 1
fi

if [ ! -d "$SPECWARE4"/Applications/Specware ]; then
   echo "Failed to $act: could not find directory
   $SPECWARE4/Applications/Specware" 2>&1
   exit 1
fi

cd "$SPECWARE4"/Applications/Specware

export SWPATH; SWPATH="$SPECWARE4":.
EXIT_ON_ERRORS="$SPECWARE4"/Applications/Handwritten/Lisp/exit-on-errors

if [ -f lisp ]; then
   echo "Failed to $act, $SPECWARE4/Applications/Specware/lisp is not a directory" 2>&1
   exit 1
fi


if [ ! -f lisp/Specware4.lisp -a ! -f Specware4-base.lisp ] ; then
   echo "Failed to $act: could not find $SPECWARE4/Applications/Specware/lisp/Specware4.lisp
   or $SPECWARE4/Applications/Specware/Specware4-base.lisp" 2>&1
   exit 1
fi

if [ ! -f lisp/Specware4.lisp ]; then
    echo "Could not find $SPECWARE4/Applications/Specware/lisp/Specware4.lisp,
    using cvs saved lisp, $SPECWARE4/Applications/Specware/Specware4-base.lisp" 2>&1
    if [ ! -d lisp ]; then
	echo "mkdir lisp"
	mkdir lisp
    fi
    echo "cp -p -f Specware4-base.lisp lisp/Specware4.lisp"
    cp -p -f Specware4-base.lisp lisp/Specware4.lisp
fi

if [ Specware4-base.lisp -nt lisp/Specware4.lisp ]; then
    echo "$SPECWARE4/Applications/Specware/lisp/Specware4.lisp is older than
    cvs saved lisp, $SPECWARE4/Applications/Specware/Specware4-base.lisp" 2>&1
    echo "Using $SPECWARE4/Applications/Specware/Specware4-base.lisp" 2>&1
    if [ ! -d lisp ]; then
	echo "mkdir lisp"
	mkdir lisp
    fi
    echo "cp -p -f Specware4-base.lisp lisp/Specware4.lisp"
    cp -p -f Specware4-base.lisp lisp/Specware4.lisp
fi

cp -f bin/linux/Specware4.cmuimage bin/linux/Specware4-save.cmuimage

cd Handwritten/Lisp

# We load the new Specware4.lisp twice, each in a fresh lisp session. The
# first time compiles everything.  This may not be necessary but it is
# easier just to load it twice rather than to try to figure out if something
# needs to be compiled.
$LISP <<-XXXX
	(load "$EXIT_ON_ERRORS")
	(exiting-on-errors 
	  (load "Specware4.lisp"))
	(quit)
XXXX

# The second time is just to do the dumplisp. If we do it in one go,
# and something needs compiling, the generated dxl file is almost 4
# times larger.


echo " "
echo "Loading Specware ... (for dumplisp)"
echo " "
$LISP <<-XXXX
	(load "$EXIT_ON_ERRORS")
	(exiting-on-errors 
	  (load "BuildPreamble.lisp")
	  (load "Specware4.lisp")
	  (load "license.lisp"))
#+cmu
	  (progn (setq ext:*environment-list* ())
		 (setq lisp::lisp-environment-list ()))

	(ext:save-lisp "$SPECWARE4/Applications/Specware/bin/linux/Specware4.cmuimage")
XXXX


# Now, build the rest of the directory tree.

if [ -d "$SPECWARE4"/distribution-cmulisp ]; then
    if [ ! -d "$SPECWARE4"/distribution-cmulisp-backup ]; then
	mkdir "$SPECWARE4"/distribution-cmulisp-backup
    fi
    mv "$SPECWARE4"/distribution-cmulisp/* "$SPECWARE4"/distribution-cmulisp-backup/ -f
else
    mkdir "$SPECWARE4"/distribution-cmulisp
fi

mkdir "$SPECWARE4"/distribution-cmulisp/Library
mkdir "$SPECWARE4"/distribution-cmulisp/Library/IO

cp "$SPECWARE4"/Library/Base "$SPECWARE4"/distribution-cmulisp/Library -r
cp "$SPECWARE4"/Library/Base.sw "$SPECWARE4"/distribution-cmulisp/Library
cp "$SPECWARE4"/Library/IO/Emacs "$SPECWARE4"/distribution-cmulisp/Library/IO -r

# TODO: move all ilisp-20020831 files to the ilisp directory in CVS
mv "$SPECWARE4"/distribution-cmulisp/Library/IO/Emacs/ilisp-20020831/ "$SPECWARE4"/distribution-cmulisp/Library/IO/Emacs/ilisp/

rm "$SPECWARE4"/distribution-cmulisp/Library/Base/CVS/* -rf
rmdir "$SPECWARE4"/distribution-cmulisp/Library/Base/CVS
rm "$SPECWARE4"/distribution-cmulisp/Library/Base/Handwritten/CVS/* -rf
rmdir "$SPECWARE4"/distribution-cmulisp/Library/Base/Handwritten/CVS
rm "$SPECWARE4"/distribution-cmulisp/Library/Base/Handwritten/Lisp/CVS/* -rf
rmdir "$SPECWARE4"/distribution-cmulisp/Library/Base/Handwritten/Lisp/CVS
rm "$SPECWARE4"/distribution-cmulisp/Library/IO/Emacs/CVS/* -rf
rmdir "$SPECWARE4"/distribution-cmulisp/Library/IO/Emacs/CVS
rm "$SPECWARE4"/distribution-cmulisp/Library/IO/Emacs/ilisp/CVS/* -rf
rmdir "$SPECWARE4"/distribution-cmulisp/Library/IO/Emacs/ilisp/CVS

mkdir "$SPECWARE4"/distribution-cmulisp/Examples
mkdir "$SPECWARE4"/distribution-cmulisp/Examples/Matching

cp "$SPECWARE4"/UserDoc/tutorial/example/* "$SPECWARE4"/distribution-cmulisp/Examples/Matching
cp "$SPECWARE4"/UserDoc/examples/* "$SPECWARE4"/distribution-cmulisp/Examples -r

rm "$SPECWARE4"/distribution-cmulisp/Examples/CVS/* -rf
rmdir "$SPECWARE4"/distribution-cmulisp/Examples/CVS
rm "$SPECWARE4"/distribution-cmulisp/Examples/simple1/CVS/* -rf
rmdir "$SPECWARE4"/distribution-cmulisp/Examples/simple1/CVS
rm "$SPECWARE4"/distribution-cmulisp/Examples/simple1/test.lisp
rm "$SPECWARE4"/distribution-cmulisp/Examples/simple2/CVS/* -rf
rmdir "$SPECWARE4"/distribution-cmulisp/Examples/simple2/CVS
rm "$SPECWARE4"/distribution-cmulisp/Examples/simple2/Refs/CVS/* -rf
rmdir "$SPECWARE4"/distribution-cmulisp/Examples/simple2/Refs/CVS
rm "$SPECWARE4"/distribution-cmulisp/Examples/simple2/Specs/CVS/* -rf
rmdir "$SPECWARE4"/distribution-cmulisp/Examples/simple2/Specs/CVS
rm "$SPECWARE4"/distribution-cmulisp/Examples/simple2/test.lisp
rm "$SPECWARE4"/distribution-cmulisp/Examples/simple3/CVS/* -rf
rmdir "$SPECWARE4"/distribution-cmulisp/Examples/simple3/CVS
rm "$SPECWARE4"/distribution-cmulisp/Examples/simple3/test.lisp

mkdir "$SPECWARE4"/distribution-cmulisp/Documentation

cp "$SPECWARE4"/UserDoc/language-manual/SpecwareLanguageManual.pdf "$SPECWARE4"/distribution-cmulisp/Documentation
cp "$SPECWARE4"/UserDoc/tutorial/SpecwareTutorial.pdf "$SPECWARE4"/distribution-cmulisp/Documentation
cp "$SPECWARE4"/UserDoc/user-manual/SpecwareUserManual.pdf "$SPECWARE4"/distribution-cmulisp/Documentation
cp "$SPECWARE4"/UserDoc/cheat-sheet/Specware-405-QuickReference.pdf "$SPECWARE4"/distribution-cmulisp/Documentation

mkdir "$SPECWARE4"/distribution-cmulisp/Patches

##  TODO: copy highest-numbered patch from "$SPECWARE4"/Release/Linux/CMU/Patches
cp "$SPECWARE4"/Release/Linux/CMU/Patches/patch-4-0-6.x86f "$SPECWARE4"/distribution-cmulisp/Patches

cp "$SPECWARE4"/Release/Linux/CMU/Specware-cmulisp "$SPECWARE4"/distribution-cmulisp

cp "$SPECWARE4"/Applications/Specware/bin/linux/Specware4.cmuimage "$SPECWARE4"/distribution-cmulisp
