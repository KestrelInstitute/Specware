#!/bin/bash --noprofile

# This script prepares a bootstrap image suitable for processing Specware4.sw to produce Specware4.lisp

# The --noprofile inhibits loading of ~/.bash_profile and ~/.profile
# files. See "man bash" for details. 

# --------------------------------------------------------------------------------
# First ensure that various shell variables have reasonable values
# --------------------------------------------------------------------------------

act='Prepare bootstrap image suitable for generating Specware4.Lisp from Specware4.sw'

PATH=/bin:/usr/bin:/etc:/sbin:/usr/sbin

SCRIPT_DIR=`/usr/bin/dirname $0`
cd -P "$SCRIPT_DIR"
SCRIPT_DIR=`pwd`

. "$SCRIPT_DIR"/Verify_Specware_Variables
. "$SPECWARE4"/Scripts/unix/Verify_ACL


BOOTSTRAP_DXL="$BIN_DIR"/Bootstrap.dxl
SPECWARE4_DXL="$BIN_DIR"/Specware4.dxl
SPECWARE_BASE_LISP="$SPECWARE4"/Applications/Specware/Specware4-base.lisp
SPECWARE_LISP="$SPECWARE4"/Applications/Specware/lisp/Specware4.lisp

# --------------------------------------------------------------------------------
# If pre-existing Bootrap.dxl exists and is current, use it.
# --------------------------------------------------------------------------------

if [ -f "$BOOTSTRAP_DXL" \
     -a \( \( ! -f "$SPECWARE4_DXL"      \) -o "$BOOTSTRAP_DXL" -nt "$SPECWARE4_DXL"      \) \
     -a \( \( ! -f "$SPECWARE_BASE_LISP" \) -o "$BOOTSTRAP_DXL" -nt "$SPECWARE_BASE_LISP" \) \
     -a \( \( ! -f "$SPECWARE_LISP"      \) -o "$BOOTSTRAP_DXL" -nt "$SPECWARE_LISP"      \) ]; then

  echo "Using current $BOOTSTRAP_DXL"
  echo " " 
  cd "$BIN_DIR"
  ls -sltra *.dxl
  echo " " 
  exit 0
fi

# --------------------------------------------------------------------------------
# If pre-existing Specware4.dxl exists and is current, use it.
# --------------------------------------------------------------------------------

if [ -f "$SPECWARE4_DXL" \
     -a \( \( ! -f "$SPECWARE_BASE_LISP" \) -o "$SPECWARE4_DXL" -nt "$SPECWARE_BASE_LISP" \) \
     -a \( \( ! -f "$SPECWARE_LISP"      \) -o "$SPECWARE4_DXL" -nt "$SPECWARE_LISP"      \) ]; then
   
   #----------------- Use Specware4.dxl ------------------#
   
   # Specware.dxl exists and neither Specware4-base.lisp nor Specware4.lisp is newer
   echo " "
   echo "  Bootstrapping from existing Specware image: bin/linux/Specware4.dxl"
   echo " "
   cd "$BIN_DIR"
   /bin/rm -f Bootstrap.dxl
   ln -s Specware4.dxl Bootstrap.dxl
   echo " " 
   ls -sltra *.dxl
   echo " " 
   exit 0

fi

echo cd -P "$SPECWARE4"/Applications/Specware
cd -P "$SPECWARE4"/Applications/Specware

# --------------------------------------------------------------------------------
# If necessary, copy Specware4-base.lisp to lisp/Specware4.lisp
# --------------------------------------------------------------------------------

if [ -f "$SPECWARE_BASE_LISP" \
     -a \(  \( ! -f "$SPECWARE_LISP" \) -o "$SPECWARE_BASE_LISP" -nt "$SPECWARE_LISP" \) ]; then
 
   if [ -f "$SPECWARE_LISP" ]; then
      echo " " 
      echo "  CVS saved lisp, Specware4-base.lisp, is newer than Bootstrap.dxl, Specware4.dxl, and lisp/Specware4.lisp (or they don't even exist)"
      echo " " 
   fi
   
   if [ ! -d lisp ]; then
      echo "mkdir lisp"
      mkdir lisp
   fi
   
   echo "cp -p -f Specware4-base.lisp lisp/Specware4.lisp"
   cp -p -f Specware4-base.lisp lisp/Specware4.lisp
   echo " "
   
else
   echo " "
   echo "Bootstrapping from previously generated lisp: lisp/Specware4.lisp"
   echo " "
fi
   

# --------------------------------------------------------------------------------
# Build new Bootstrap.dxl from lisp/Specware4.lisp
# --------------------------------------------------------------------------------

if [ ! -f lisp/Specware4.lisp ]; then
   echo "Cannot find Bootstrap.dxl, Specware4.dxl, Specware-base.lisp, or lisp/Specware.lisp"
   echo "Giving up."
   exit 1
fi

if [ -f bin/linux/Specware4.dxl ]; then
   echo "  lisp/Specware4.lisp is newer than bin/linux/Specware4.dxl"
fi
if [ -f bin/linux/Bootstrap.dxl ]; then
   echo "  lisp/Specware4.lisp is newer than bin/linux/Bootstrap.dxl"
fi
      
echo " "
cd Handwritten/Lisp
export SWPATH=/:.
EXIT_ON_ERRORS="$SPECWARE4"/Applications/Handwritten/Lisp/exit-on-errors
MEMORY_MANAGEMENT="$SPECWARE4"/Applications/Handwritten/Lisp/memory-management
echo "\$SWPATH=$SWPATH"
   
echo " "
echo "Removing old Bootstrap.dxl, then creating new one."
echo " "
   
/bin/rm -f "$BOOTSTRAP_DXL"
   
# Note the use of the <<-XXXX in the following. The - means that preceeding
# tabs are removed.  Thus the tabs that follow are significant. If you
# change them to spaces, the end of the "here-document" is not recognized
# (the XXXX).
   
"$LISP" -batch <<-XXXX
	(progn
	 (format t "~%--------------------------------------------------------------------------------~%")
	 (load "$EXIT_ON_ERRORS")
	 (load "$MEMORY_MANAGEMENT") 
	 (enlarge-stack)
	 (format t "~%--------------------------------------------------------------------------------~%")
	 (exiting-on-errors 
	   (load "Specware4.lisp"))
	 ;; We have two separate exiting-on-errors forms because we must
	 ;; finish evaluating the load of Specware4.lisp to create the 
	 ;; Specware package before the reader sees a reference to it.
	 (format t "~%--------------------------------------------------------------------------------~%")
	 (format t "~%Building $BOOTSTRAP_DXL~%")
	 (excl::dumplisp :name "$BOOTSTRAP_DXL"))
	XXXX
RC=$?
      
if [ $RC -ne 0 ]; then
   echo " "
   echo "Prepare_Bootstrap_Image_ACL failed with code $RC, exiting ..."
   echo " "
   exit $RC
fi

echo " " 
cd "$BIN_DIR"
ls -sltra *.dxl
echo " " 


