#!/bin/bash --noprofile

# This script bootstraps Specware4 and saves the resulting cache,
# to facilitate subsquent bootstraps of specware4 and/or its extensions.
#
# The --noprofile inhibits loading of ~/.bash_profile and ~/.profile
# files. See "man bash" for details. The 'set -v' turns on echoing of
# lines read. This will be removed later.

act='bootstrap'

PATH=/bin:/usr/bin:/etc:/sbin:/usr/sbin

# set -v

# Test whether SPECWARE4 has been set
if [ -z "$SPECWARE4" ]; then
    echo "Failed to $act, SPECWARE4 environment variable not set" 2>&1
    exit 1
fi

# Test whether SPECWARE4 is a directory
if [ ! -d "$SPECWARE4" ]; then
   echo "Failed to $act, $SPECWARE4 is not a directory" 2>&1
   exit 1
fi

# Ensure SPECWARE4 is set to full pathname:
case "$SPECWARE4" in
    /*) : ok;;
    *)  SPECWARE="`pwd`/$SPECWARE4";;
esac

if [ ! -d "$SPECWARE4"/Applications/Specware ]; then
   echo "Failed to $act: could not find directory $SPECWARE4/Applications/Specware" 2>&1
   exit 1
fi

echo cd "$SPECWARE4"/Applications/Specware
cd "$SPECWARE4"/Applications/Specware

# Try to find lisp executable:

if [ -z "$LISP" ]; then
   for L in /usr/local/acl/acl62/alisp /usr/local/acl/acl61/alisp /usr/local/acl/acl501/lisp; do
      if [ -x "$L" ]; then
         export LISP="$L"; break
      fi
   done
fi

if [ -z "$LISP" ]; then
   echo "Failed to $act, no LISP executable found" 2>&1
   exit 1
fi

if [ ! -x "$LISP" ]; then
   echo "Failed to $act, $LISP is not executable" 2>&1
   exit 1
fi

echo " "
if [ -f lisp/Specware4.lisp ]; then
  echo "Saving previous specware lisp file ..."
  echo "cp -p -f lisp/Specware4.lisp lisp/Specware4-save.lisp"
  cp -p -f lisp/Specware4.lisp lisp/Specware4-save.lisp
else
  echo "Note: No previous specware lisp file."
fi
echo " "
if [ -f bin/linux/Specware4.dxl ]; then
  echo "Saving previous specware image ..."
  echo "cp -p -f bin/linux/Specware4.dxl bin/linux/Specware4-save.dxl"
  cp -p -f bin/linux/Specware4.dxl bin/linux/Specware4-save.dxl
else
  echo "Note: No previous specware image."
fi
echo " "

# Note the use of the <<-XXXX in the following. The - means that preceeding
# tabs are removed.  Thus the tabs that follow are significant. If you
# change them to spaces, the end of the "here-document" is not recognized
# (the XXXX).

# Is there a way to inhibit all the warnings (eg unused variable)
# when Lisp loads?

export SWPATH="$SPECWARE4":.
EXIT_ON_ERRORS="$SPECWARE4"/Applications/Handwritten/Lisp/exit-on-errors
MEMORY_MANAGEMENT="$SPECWARE4"/Applications/Handwritten/Lisp/memory-management

echo "\$SWPATH=$SWPATH"

# All the toplevel routines that activate Specware return a boolean value.
# They return true if the call to Specware succeeded without activating
# Specware's toplevel handler. They return false (lisp nil) when the
# handler is invoked. If, when bootrapping, the toplevel handler is
# called, then we abort the bootstrap.

if [ -f lisp ]; then
   echo "Failed to $act, $SPECWARE4/Applications/Specware/lisp is not a directory" 2>&1
   exit 1
fi

echo " "
echo cd "$SPECWARE4"/Applications/Specware/Handwritten/Lisp
cd "$SPECWARE4"/Applications/Specware/Handwritten/Lisp

echo " "
echo "Loading Specware ... (for cached dumplisp)"
echo " "

# use Specware4-save.dxl so that dump of Specware4.dxl won't crash running image
"$LISP" -I "$SPECWARE4"/Applications/Specware/bin/linux/Specware4-save.dxl -batch <<-XXXX
	:swpath
	;; (load "$EXIT_ON_ERRORS")    ; already loaded
	;; (load "$MEMORY_MANAGEMENT") ; already loaded
	(compact-memory t 0 64000000)
	(set-gc-parameters-for-build t)
	(exiting-on-errors 
	  (unless (sw "/Applications/Specware/Specware4")
            (exit 1)))
	(compact-memory t -1 0)
	(set-gc-parameters-for-use t)
	(format t "~%Dumping image with cached results of (sw \"/Applications/Specware/Specware4\")...~%")
        (excl::dumplisp :name "$SPECWARE4/Applications/Specware/bin/linux/Specware4.dxl")
XXXX
RC=$?

ls -sltr $SPECWARE4/Applications/Specware/bin/linux/*.dxl

# If the load failed (non-zero exit status) then we abort.
if [ $RC -ne 0 ]; then
  echo ""
  echo "Second load failed with code $RC, exiting ..."
  exit $RC
fi

cd "$SPECWARE4"/Applications/Specware/lisp
if cmp -s Specware4.lisp Specware4-save.lisp; then
  echo " "
  echo "The bootstrap reached a fixed point"
fi
